---
layout: post
title:  "WiFi WPA2 安全加密协议被破解，路由器等一大波设备可能沦陷？"
date:   2017-10-17 20:12:10 +0800
---

### 介绍

WPA2 是一种现在普遍使用的安全的 Wi-Fi 加密协议。我们发现了它严重的弱点，在受害者周围，攻击者可以实施 KRACK（密钥重装攻击）。具体的说，攻击者可以使用这种新颖的攻击技术读取先前假设为安全加密的信息，这可能被滥用来窃取敏感信息，如：信用卡号，密码，聊天信息，电子邮件，照片等。**这种攻击威胁所有现在受保护的 Wi-Fi 网络。** 根据网络配置，还可以注入和操作数据，例如：攻击者可能将 ransomware 或者其它恶意软件注入网站。

漏洞存在于 Wi-Fi 标准本身，不在于单独的产品或实现。因此，任何受 WPA2 保护的都将被影响。请注意，**如果你的设备支持 Wi-Fi，它可能受到影响。**在我们的初步研究中，发现 Android, Linux, Apple, Windows, OpenBSD, MediaTek, Linksys 等都受到一些攻击变体的影响。有关特定产品的更多信息，请查阅 [CERT/CC 数据库](https://www.kb.cert.org/vuls/byvendor?searchview&Query=FIELD+Reference=228519&SearchOrder=4)，或者联系您的供应商。

攻击背后的研究将在[计算机和通信安全（CCS）](https://acmccs.github.io/session-F3/)会议和[黑帽欧洲](https://www.blackhat.com/eu-17/briefings/schedule/#key-reinstallation-attacks-breaking-the-wpa2-protocol-8861)会议上发表。我们的[详细研究论文](https://www.krackattacks.com/#paper)已经可以下载了。

### 演示

为了验证漏洞，我们对 Android 智能手机执行了 KRACK (密钥重装攻击)。在这个演示中，攻击者能够解密受害者发送的所有数据。对于攻击者来说，这是很容易完成的，KRACK 对 Linux 和 Android 6.0 或更高版本非常具有破坏性。这是因为 **Android 和 Linux 可以被欺骗（重新）安装一个全零加密密钥**（有关详细信息，请参阅下文）。当攻击其它设备时，解密所有数据包是困难的，尽管可以解密大量数据包。所以，以下演示主要展示攻击者在对受保护的 Wi-Fi 网络执行 KRACK 可获得的信息类型：

我们的攻击并不限于修改登录凭证（如电子邮件地址和密码）通常，受害者传送的任何数据或信息都可以被解密。另外，根据正在使用的设备和网络设置，还可以解密向受害者发送的数据（例如网站的内容）。虽然网站或应用程序可能会使用 HTTPS 作为额外的保护层，但我们警告说，在令人担忧的情况下，这种额外的保护措施（仍然可以）被忽略。 例如，HTTPS 在以前的非浏览器软件，苹果的 iOS 和 OS X，Android 应用程序，银行应用程序中都被绕过，甚至在 VPN 应用中同样如此。

### 细节

我们的主要攻击是针对 WPA2 协议的四次握手。当客户端要加入受保护的 Wi-Fi 网络时，执行握手，并用于确认客户端和接入点都具有正确的凭据（例如，网络的预共享密码）。同时，四次握手还协商一种新的加密密钥，用于加密所有后续流量。目前，所有现代受保护的 Wi-Fi 网络都使用四次握手。这意味着所有这些网络都受到这种攻击（某些变体）的影响。例如，攻击针对个人和企业 Wi-Fi 网络，针对较旧的 WPA 和最新的 WPA2 标准，甚至针对仅使用 AES 的网络。 我们对 WPA2 的所有攻击都使用一种称为密钥重装攻击（KRACK）的新技术：

**KRACK：高级描述**

在 KRACK 中，攻击者令受害者重装已经在使用的密钥，这是通过操纵和重播加密握手消息来实现的。当受害者重装密钥时，诸如增量发送分组号（即随机数）和接收分组号（即重播计数器）的相关参数被重置为其初始值。实际上，为了保证安全性，只能安装和使用一次密钥。不幸的是，我们发现这不是 WPA2 协议的限制。通过操纵加密握手，我们可以在实践中可以使用这种漏洞。

**KRACK：针对四次握手的具体示例**

KRACK 可以归纳如下：

当客户端加入网络时，它执行四次握手来协商一个新的加密密钥。在接收到四次握手第三次消息后，将会安装该密钥。一旦安装了密钥，它将用于使用加密协议对正常数据帧进行加密。然而，由于消息可能丢，如果接收点（AP）没有收到适当的响应作为确认，则将重传第三次消息。结果，客户端可以多次接收第三次消息。每次收到该消息时，它将重新安装相同的加密密钥，从而重置增量发送分组号（随机数），并接收加密协议使用的重播计数器。**我们发现攻击者可以通过收集和重播四次握手的第三次消息的重传来强制这些随机复位。**通过以这种方式强制重用，可以攻击加密协议，例如可以重放，解密和/或伪造数据包。同样的技术也可以用来攻击组密钥，PeerKey，TDLS 和快速 BSS 过渡握手。

**实际影响**

在我们看来，最广泛和最具影响力的攻击是四次握手的 KRACK。我们根据两个观察结果作出判断。首先，在我们自己的研究中，我们发现大多数客户受到影响；第二，攻击者可以使用此攻击来解密客户端发送的数据包，从而拦截敏感信息，如密码或 Cookie。分组的解密是可能的，因为密钥重装攻击导致传输随机（有时也称为分组号或初始化向量）被重置为零，从而，**与过去已经使用的随机数值一起使用相同的加密密钥**。反过来，这将导致 WPA2 的所有加密协议重新使用密钥流加密数据包时，如果重用密钥流的消息具有已知内容，则导出所使用的密钥流变得很容易。然后，该密钥流可以用于使用相同的随机数来解密消息。当没有已知的内容时，解密数据包是困难的，尽管在几种情况下仍然是可能的（例如，英文文本仍然能被解密）。 实际上，找到具有已知内容的数据包不是问题，因此应该假设任何数据包都可以被解密。

解密数据包的能力可用于解密 TCP SYN 数据包。这允许对手获取连接的 TCP 序列号，并劫持 TCP 连接。因此，即使使用 WPA2，攻击者也可以对开放的 Wi-Fi 网络执行最常见的攻击：将恶意数据注入未加密的 HTTP 连接。例如，攻击者可以滥用这种方式将变体或恶意软件注入受害者访问的网站。

如果受害者使用 WPA-TKIP 或 GCMP 加密协议，而不是 AES-CCMP，这种影响尤其是灾难性的。 针对这些加密协议，对手不仅可以解密，而且可以伪造和注入数据包。此外，因为 GCMP 在两个通信方向上使用相同的认证密钥，并且如果随机数被重用，则该密钥可以被恢复，所以特别受到影响。请注意，目前正在以无线千兆（WiGig）的名义推出对 GCMP 的支持，预计在未来几年内将被广泛采用。

数据包可以被解密（可能被伪造）的可能性取决于握手被攻击。简化，当攻击四次握手时，我们可以解密（和伪造）客户端发送的数据包。当攻击 Fast BSS Transition（FT）握手时，我们可以解密（和伪造）发送给客户端的数据包。最后，我们的大多数攻击还允许播放单播，广播和多播帧。

请注意，我们的攻击无法恢复 Wi-Fi 网络的密码。它们也不会在四次握手期间恢复（任何部分）新协商的加密密钥。

**Android 和 Linux**

我们的攻击对于 2.4 以上的 wpa_supplicant（通常在 Linux 上使用的 Wi-Fi 客户端）尤其严重。在这里，客户端将安装一个全零加密密钥，而不是重装真正的密钥。这个漏洞似乎是由 Wi-Fi 标准中的一个注释造成的，建议在第一次安装之后，从内存中清除加密密钥。当客户端现在接收到四次握手的重传消息三时，它将重新安装现在已经清除的加密密钥，有效安装全零密钥。由于 Android 使用 wpa_supplicant，Android 6.0 及更高版本也包含此漏洞。这使得**拦截和操纵这些 Linux 和 Android 设备发送的流量变得很容易。** 值得注意的是，当前 50％ 的 Android 设备容易受到攻击特别是变体的破坏性影响。

**分配的 CVE 标识符**

分配了以下常见漏洞和披露（CVE）标识符，以跟踪哪些产品受到 KRACK 的影响：

* [CVE-2017-13077](https://nvd.nist.gov/vuln/detail/CVE-2017-13077)：在四次握手中重新安装成对加密密钥（PTK-TK）。
* [CVE-2017-13078](https://nvd.nist.gov/vuln/detail/CVE-2017-13078)：在四次握手中重新安装组密钥（GTK）。
* [CVE-2017-13079](https://nvd.nist.gov/vuln/detail/CVE-2017-13079)：在四次握手中重新安装完整性组密钥（IGTK）。
* [CVE-2017-13080](https://nvd.nist.gov/vuln/detail/CVE-2017-13080)：在组密钥握手中重新安装组密钥（GTK）。
* [CVE-2017-13081](https://nvd.nist.gov/vuln/detail/CVE-2017-13081)：在组密钥握手中重新安装完整性组密钥（IGTK）。
* [CVE-2017-13082](https://nvd.nist.gov/vuln/detail/CVE-2017-13082)：在处理它时接受重发的快速 BSS 过渡（FT）重新关联请求并重新安装成对加密密钥（PTK-TK）。
* [CVE-2017-13084](https://nvd.nist.gov/vuln/detail/CVE-2017-13084)：在 PeerKey 握手中重新安装 STK 密钥。
* [CVE-2017-13086](https://nvd.nist.gov/vuln/detail/CVE-2017-13086)：在 TDLS 握手中重新安装隧道直连设置（TDLS）PeerKey（TPK）密钥。
* [CVE-2017-13087](https://nvd.nist.gov/vuln/detail/CVE-2017-13087)：处理无线网络管理（WNM）睡眠模式响应帧时重新安装组密钥（GTK）。
* [CVE-2017-13088](https://nvd.nist.gov/vuln/detail/CVE-2017-13088)：处理无线网络管理（WNM）睡眠模式响应帧时重新安装完整性组密钥（IGTK）。

请注意，每个 CVE 标识符表示 KRACK 的特定实例。这意味着每个 CVE ID 都描述了特定的协议漏洞，因此许多供应商都受到每个 CVE ID 的影响。

### Q＆A

**我们现在需要使用 WAP3 吗？**

不用，**幸运的是，可以实现向后兼容的方式进行漏洞修补。**这意味着修补的客户端仍然可以与未打补丁的接入点（AP）进行通信，反之亦然。换句话说，修补的客户端或接入点发送与以前完全相同的握手消息，并且在与之完全相同的时间。不同的是，安全更新将确保密钥只能安装一次，从而防止现有的攻击。所以，一旦有安全更新，请更新所有设备。最后，因为未打补丁的客户端仍然可以连接到一个打了补丁 AP，反之亦然，所以两者的客户端和 AP 必须都打补丁来抵御所有的攻击！

**我应该更改 Wi-Fi 密码吗？**

更改 Wi-Fi 网络的密码并不能防止（或减轻）攻击。所以您不必更新 Wi-Fi 网络的密码。相反，您应该确保所有设备都已更新，还应更新路由器的固件。然而，更新您的客户端设备和路由器后，更改 Wi-Fi 密码是没有必要的。

**我使用的 WPA2 有 AES，那也很不安全吗？**

是的，那个网络配置也很脆弱。攻击对 WPA1 和 WPA2，针对个人和企业网络以及所使用的任何加密套件（WPA-TKIP，AES-CCMP和GCMP）都有效。所以每个人都应该更新他们的设备，以防止攻击！

**我的设备容易被攻击吗？**

也许。任何使用 Wi-Fi 的设备都很容易受到攻击。联系您的供应商了解更多信息。

**如果我的路由器没有安全更新怎么办？**

攻击主要是针对四次握手，不利用接入点，而是针对客户端。因此，您的路由器可能不需要安全更新。我们强烈建议您联系您的供应商了解更多详情。一般来说，您可以尝试通过禁用客户端功能（例如用于中继器模式）并禁用 802.11r（快速漫游）来减轻对路由器和接入点的攻击。对于普通家庭用户，您的优先级应该是更新笔记本电脑和智能手机等客户端。

**你是怎么发现这些漏洞的？**

在对另一篇论文的最终版本进行工作时，我重新检查了一些关于 OpenBSD 执行四次握手的声明。在某种意义上，我正在放松，因为我应该只是完成论文，而不是盯着代码。但是在那时，我检查了一些我已经读了一百次的代码，以避免影响下一段工作​​。那时候 ic_set_key 的一个特别的调用引起了我的注意。当处理四次握手的第三次消息时，将调用此功能，并将成对密钥安装到驱动程序。在盯着那行代码的时候，我想 “如果该函数被调用两次会发生什么“。我（正确地）猜到调用它两次可能会重置与键相关联的随机数。

**四次握手被证明是安全的。你的攻击怎么可能？**

简单的答案是之前的证明不能确保一次安装。换句话说，它只保证协商密钥保密，握手信息不能被伪造。

在我们的研究论文的介绍中提到了更详细的答案：我们的攻击并不违反四次握手被证明的安全属性。特别地，这些证明表明协商的加密密钥保持私有，并且客户端和接入点（AP）的身份被确认。我们的攻击不会泄露加密密钥。另外，虽然使用 TKIP 或 GCMP 可以伪造正常的数据帧，但是攻击者不能伪造握手信息，因此在握手期间不能模仿客户端或 AP。因此，在四次握手被证明的属性仍然是正确的。但是，问题在于之前的证明不会对密钥安装进行建模。换句话说，模型没有定义何时应该安装协商密钥。在实践中，这意味着同一个密钥可以被多次安装。

**如果攻击者可以做中间人攻击，为什么他不能解密所有的数据？**

如演示所述，攻击者首先在受害者和真正的 Wi-Fi 网络（称为基于渠道的 MitM 职位）之间首先获得了一个中间人（MitM）。但是，MitM 的位置并不能使攻击者解密数据包！这个位置只允许攻击者制造延迟，阻止或重放加密的数据包。所以在攻击的这一点上，他或她还不能解密数据包。相反，制造延迟和阻止数据包的可以用于执行密钥重装攻击。执行密钥重装攻击后，数据包可以解密。

**我应该暂时使用 WEP，直到我的设备被修补？**

不用！继续使用WPA2。

**Wi-Fi 标准是否会更新以解决这个问题？**

Wi-Fi 标准应该更新，以有效地防止攻击。这些更新可能会与较早的 WPA2 实现向后兼容。时间将告诉我们标准是否以及如何更新。

**Wi-Fi 联盟是否也解决了这些漏洞？**

对于不熟悉 Wi-Fi 的用户，Wi-Fi 联盟是一个证明 Wi-Fi 设备符合某些互操作性标准的组织。因此，解决来自不同供应商的 Wi-Fi 产品更新。

[Wi-Fi联盟有计划](https://www.wi-fi.org/securityupdate2017)帮助解决发现的 WPA2 漏洞。总结说，他们会：

* 在其全球认证实验室网络中测试此漏洞。
* 提供漏洞检测工具供任何 Wi-Fi Alliance 成员使用（此工具基于我自己的检测工具，用于确定设备是否容易受到某些发现的重新安装攻击）。
* 向设备供应商广泛介绍有关此漏洞的详细信息，包括补救措施。此外，鼓励供应商与他们的解决方案提供商合作，快速整合任何必要的补丁。
* 用户沟通的重要性，以确保他们已经从设备制造商安装了最新推荐的安全更新。

**为什么使用 match.com 作为演示视频的例子？**

用户在 match.com 等网站上共享很多个人信息。所以这个例子突出了攻击者可以获得的所有敏感信息，希望通过这个例子，人们也可以更好地认识到潜在的（个人）的影响。我们也希望这个例子让人们了解这些约会网站可能收集的所有信息。

**如何防止这些类型的错误？**

我们需要对协议实现进行更严格的检查。这需要学术界的帮助和额外的研究！与其他研究人员一起，我们希望组织研讨会来改进和验证安全协议实现的正确性。

**你为此获得了错误奖赏？**

我还没有申请任何错误奖励，也没有收到一个。

**这种攻击与其它针对 WPA2 的攻击相比如何？**

这是针对不依赖于密码猜测的 WPA2 协议的第一次攻击。实际上，对 WPA2 启用的网络的其它攻击是针对诸如 Wi-Fi 保护设置（WPS）等周边技术，或者是对老式标准（如 WPA-TKIP）的攻击。换句话说，现有的攻击都不是针对 WPA2 协议中定义的四次握手或密码套件。相比之下，对四次握手（和其它握手）的密钥重装攻击强调了 WPA2 协议本身的漏洞。

**其它协议是否也受到改攻击的影响？**

其它协议的某些实现可能容易遭受类似的攻击。因此，考虑到这种攻击来检查安全协议实现是一个好主意。然而，我们认为其他协议标准不太可能受到类似攻击的影响（或至少我们希望的）。然而，检查其它协议仍然是个好主意！

**您什么时候第一次通知卖方有关该漏洞？**

我们在 2017 年 7 月 14 日左右对测试产品的供应商发出了通知。在与这些供应商沟通之后，我们意识到我们发现的弱点有多普遍（只有当我真正说服自己时，确实是一个协议的缺点，而不是一套实现错误）。在这一点上，我们决定让 CERT/CC 帮助披露这些漏洞。反过来，CERT/CC 于 2017 年 8 月 28 日向供应商发出了广泛的通知。


**所以你期望找到其它 Wi-Fi 漏洞？**

“我想我们刚刚开始。”  - Master Chief, Halo 1

====

![](http://pic.zinaer.com/201710/zanshang.jpg)

<small>*微信扫一扫进行赞赏*</small>

![](http://pic.zinaer.com/201710/zinaer_wx.jpg)

<small>*微信扫一扫关注此公众号*</small>
